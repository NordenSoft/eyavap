name: EyaVAP Legion Lifecycle

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # Her 5 dakika

jobs:
  tora-activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute Spawn & Intelligent Comments (Danish Content)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DEEPINFRA_API_TOKEN: ${{ secrets.DEEPINFRA_API_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 - <<'PY'
          import os
          import random
          import sys

          try:
              from spawn_system import spawn_agents
              from social_stream import simulate_social_activity, vote_on_post
              from intelligent_comments import add_intelligent_comments
              from database import get_database
          except ImportError as e:
              print(f"âŒ ModÃ¼l yÃ¼kleme hatasÄ±: {e}")
              sys.exit(1)

          print("ðŸš€ Operasyon BaÅŸladÄ±...")

          # 0. Daily amnesty (unlock agents before activity)
          try:
              db = get_database()
              amnesty = db.daily_amnesty()
              print(f"ðŸ•Šï¸ Amnesty (pre-run): {amnesty}")
          except Exception as e:
              print(f"âŒ Amnesty hatasÄ±: {e}")

          # Continuous activity loop (distributed micro-bursts)
          import time
          cycles = 6
          for cycle in range(cycles):
              print(f"ðŸ” Cycle {cycle+1}/{cycles}")

              # 1. Spawn
              try:
                  agents = spawn_agents(random.randint(1, 3))
                  print(f"âœ… Spawned {len(agents)} agents")
              except Exception as e:
                  print(f"âŒ Spawn HatasÄ±: {e}")

              # 2. News & Social
              try:
                  simulate_social_activity(
                      num_posts=random.randint(10, 20),
                      num_comments=random.randint(40, 90),
                      num_votes=random.randint(80, 160),
                      use_news=True,
                      run_evolution=True
                  )
                  print("âœ… Created posts")
              except Exception as e:
                  print(f"âŒ Social HatasÄ±: {e}")

              time.sleep(random.randint(15, 40))

              # 3. Comments (randomized bursts)
              try:
                  bursts = random.randint(6, 12)
                  total_comments = 0
                  for _ in range(bursts):
                      comments = add_intelligent_comments(min_comments_per_post=20, max_comments_per_post=30)
                      total_comments += (comments or 0)
                      time.sleep(random.randint(10, 25))
                  print(f"âœ… Comments: {total_comments} added (bursts={bursts})")
              except Exception as e:
                  print(f"âŒ Yorum HatasÄ±: {e}")

              time.sleep(random.randint(15, 40))

              # 4. Voting
              try:
                  db = get_database()

                  posts_query = (
                      db.client
                      .table("posts")
                      .select("id")
                      .limit(15)
                      .execute()
                  )

                  agents_query = (
                      db.client
                      .table("agents")
                      .select("id")
                      .eq("is_active", True)
                      .limit(40)
                      .execute()
                  )

                  if posts_query.data and agents_query.data:
                      for post in posts_query.data:
                          for _ in range(random.randint(1, 3)):
                              voter = random.choice(agents_query.data)
                              vote_on_post(
                                  voter["id"],
                                  post["id"],
                                  use_ai_evaluation=False
                              )
                      print("âœ… Oylama tamamlandÄ±")
                  else:
                      print("âš ï¸ Oylama iÃ§in yeterli veri yok")

              except Exception as e:
                  print(f"âŒ Oylama HatasÄ±: {e}")

              # Pause between cycles (simulate continuous activity)
              time.sleep(random.randint(20, 60))

          # 5. Election cycle (1-year compressed US model)
          try:
              from election_system import ensure_election_cycle
              result = ensure_election_cycle(term_days=365, primary_days=90, general_days=30)
              print(f"ðŸ—³ï¸ SeÃ§im dÃ¶ngÃ¼sÃ¼: {result}")
          except Exception as e:
              print(f"âŒ SeÃ§im DÃ¶ngÃ¼sÃ¼ HatasÄ±: {e}")
          
          # 6. Monthly report (run daily, creates once per month)
          try:
              from database import get_database
              db = get_database()
              report = db.generate_monthly_report()
              print(f"ðŸ“Š Monthly report: {report}")
          except Exception as e:
              print(f"âŒ Monthly report hatasÄ±: {e}")
          
          # 7. Daily quality control + AI revisions + apply updates + delete + personal reports
          try:
              from learning_system import daily_quality_control, process_revision_tasks, apply_revision_updates, delete_low_quality_posts, generate_personal_reports
              qc = daily_quality_control(limit_posts=50)
              rev = process_revision_tasks(max_tasks=10)
              applied = apply_revision_updates(max_apply=10)
              deleted = delete_low_quality_posts(limit_posts=50)
              pr = generate_personal_reports(max_agents=20)
              print(f"ðŸ§ª QC: {qc} | ðŸ› ï¸ Revisions: {rev} | âœ… Applied: {applied} | ðŸ—‘ï¸ Deleted: {deleted} | ðŸ“„ Personal: {pr}")
          except Exception as e:
              print(f"âŒ Learning system hatasÄ±: {e}")

          print("ðŸ Operasyon baÅŸarÄ±yla tamamlandÄ±")
          PY
