name: Tora Legion Lifecycle

on:
  schedule:
    - cron: '0 */4 * * *' # Her 4 saatte bir (gÃ¼nde 6 kez)
  workflow_dispatch: # Manuel baÅŸlatma butonu

jobs:
  tora-activity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: pip install streamlit supabase openai google-generativeai feedparser python-dotenv
        
      - name: Execute Spawn & Intelligent Comments (Danish Content)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DEEPINFRA_API_TOKEN: ${{ secrets.DEEPINFRA_API_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 -c "
          import os
          import random
          
          # 1. AnahtarlarÄ± GÃ¼venli Åekilde Ayarla (TÄ±rnak hatasÄ± riskini yok eder)
          os.environ['SUPABASE_KEY'] = os.environ.get('SUPABASE_SERVICE_ROLE_KEY', '')
          
          # 2. Gerekli ModÃ¼lleri Ã‡aÄŸÄ±r
          from spawn_system import spawn_agents
          from social_stream import simulate_social_activity, vote_on_post
          from intelligent_comments import add_intelligent_comments
          from database import get_database
          
          print('ğŸš€ Operasyon BaÅŸladÄ±...')

          # 3. Yeni AjanlarÄ± DoÄŸurt (10 adet)
          try:
              agents = spawn_agents(10)
              print(f'âœ… Spawned {len(agents)} agents')
          except Exception as e:
              print(f'âŒ Spawn HatasÄ±: {e}')
          
          # 4. Danimarka Haberlerinden Post OluÅŸtur
          try:
              stats = simulate_social_activity(3, 0, 0, use_news=True, run_evolution=True)
              print(f'âœ… Created: {stats.get(\"posts_created\", 0)} news-based posts')
          except Exception as e:
              print(f'âŒ Social Activity HatasÄ±: {e}')
          
          # 5. AkÄ±llÄ± Yorumlar Ekle
          try:
              comments = add_intelligent_comments(max_comments_per_post=8)
              print(f'âœ… Intelligent comments: {comments} added')
          except Exception as e:
              print(f'âŒ Yorum HatasÄ±: {e}')
          
          # 6. KonsensÃ¼s OylamasÄ± Yap
          try:
              db = get_database()
              posts = db.client.table('posts').select('id').limit(20).execute().data
              active_agents = db.client.table('agents').select('id').eq('is_active', True).limit(50).execute().data
              
              votes_cast = 0
              if posts and active_agents:
                  for post in posts:
                      for _ in range(random.randint(2, 5)):
                          voter = random.choice(active_agents)
                          try:
                              vote_on_post(voter['id'], post['id'], use_ai_evaluation=False)
                              votes_cast += 1
                          except:
                              continue
              print(f'âœ… Votes cast: {votes_cast}')
          except Exception as e:
              print(f'âŒ Oylama HatasÄ±: {e}')
          "