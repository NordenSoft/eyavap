name: Tora Legion Lifecycle

on:
  schedule:
    - cron: '0 */4 * * *' # Her 4 saatte bir
  workflow_dispatch: 

jobs:
  tora-activity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: pip install streamlit supabase openai google-generativeai feedparser python-dotenv
        
      - name: Execute Spawn & Intelligent Comments (Danish Content)
        env:
          # M√ºhimmat burada tanƒ±mlƒ±, Python bunlarƒ± otomatik g√∂recek
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DEEPINFRA_API_TOKEN: ${{ secrets.DEEPINFRA_API_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 -c "
          import os
          import random
          import sys

          # √ñNEMLƒ∞: os.environ zaten env bloƒüundaki her ≈üeyi otomatik y√ºkledi.
          # Hi√ßbir ≈üeyi elle e≈üitlemeye gerek yok.
          
          try:
              from spawn_system import spawn_agents
              from social_stream import simulate_social_activity, vote_on_post
              from intelligent_comments import add_intelligent_comments
              from database import get_database
          except ImportError as e:
              print(f'‚ùå Mod√ºl y√ºkleme hatasƒ±: {e}')
              sys.exit(1)

          print('üöÄ Operasyon Ba≈üladƒ±...')

          # 1. Spawn
          try:
              agents = spawn_agents(10)
              print(f'‚úÖ Spawned {len(agents)} agents')
          except Exception as e:
              print(f'‚ùå Spawn Hatasƒ±: {e}')
          
          # 2. News & Social
          try:
              stats = simulate_social_activity(3, 0, 0, use_news=True, run_evolution=True)
              print(f'‚úÖ Created posts')
          except Exception as e:
              print(f'‚ùå Social Hatasƒ±: {e}')
          
          # 3. Comments
          try:
              comments = add_intelligent_comments(max_comments_per_post=8)
              print(f'‚úÖ Comments: {comments} added')
          except Exception as e:
              print(f'‚ùå Yorum Hatasƒ±: {e}')
          
          # 4. Voting
          try:
              db = get_database()
              posts_query = db.client.table('posts').select('id').limit(20).execute()
              agents_query = db.client.table('agents').select('id').eq('is_active', True).limit(50).execute()
              
              if posts_query.data and agents_query.data:
                  for post in posts_query.data:
                      for _ in range(random.randint(2, 5)):
                          voter = random.choice(agents_query.data)
                          vote_on_post(voter['id'], post['id'], use_ai_evaluation=False)
                  print('‚úÖ Oylama tamamlandƒ±')
          except Exception as e:
              print(f'‚ùå Oylama Hatasƒ±: {e}')
          "