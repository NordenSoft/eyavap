name: EyaVAP Legion Lifecycle

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # Her 5 dakika

jobs:
  tora-activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute Spawn & Intelligent Comments (Danish Content)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DEEPINFRA_API_TOKEN: ${{ secrets.DEEPINFRA_API_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 - <<'PY'
          import os
          import random
          import sys

          try:
              from spawn_system import spawn_agents
              from social_stream import simulate_social_activity, vote_on_post
              from intelligent_comments import add_intelligent_comments
              from database import get_database
          except ImportError as e:
              print(f"âŒ ModÃ¼l yÃ¼kleme hatasÄ±: {e}")
              sys.exit(1)

          print("ðŸš€ Operasyon BaÅŸladÄ±...")

          # 0. Daily amnesty (unlock agents before activity)
          try:
              db = get_database()
              amnesty = db.daily_amnesty()
              print(f"ðŸ•Šï¸ Amnesty (pre-run): {amnesty}")
          except Exception as e:
              print(f"âŒ Amnesty hatasÄ±: {e}")

          # Budget-based scaling (low/normal/high)
          budget_mode = os.getenv("BUDGET_MODE", "normal").lower()
          scale = {"low": 0.6, "normal": 1.0, "high": 1.3}.get(budget_mode, 1.0)
          def _scale_range(a, b):
              lo = max(1, int(a * scale))
              hi = max(lo, int(b * scale))
              return (lo, hi)

          # Minute-by-minute activity loop (steady feed)
          import time
          minute_slots = 5
          for minute in range(minute_slots):
              print(f"ðŸ•’ Minute slot {minute+1}/{minute_slots}")

              # 1. Spawn
              try:
                  agents = spawn_agents(random.randint(1, 2))
                  print(f"âœ… Spawned {len(agents)} agents")
              except Exception as e:
                  print(f"âŒ Spawn HatasÄ±: {e}")

              # 2. News & Social
              try:
                  post_lo, post_hi = _scale_range(4, 7)
                  comm_lo, comm_hi = _scale_range(20, 40)
                  vote_lo, vote_hi = _scale_range(30, 60)
                  simulate_social_activity(
                      num_posts=random.randint(post_lo, post_hi),
                      num_comments=random.randint(comm_lo, comm_hi),
                      num_votes=random.randint(vote_lo, vote_hi),
                      use_news=True,
                      run_evolution=True,
                      topic_weights={
                          "generelt": 2,
                          "free_zone": 2,
                          "skat_dk": 1,
                          "sundhedsvÃ¦sen": 1,
                          "arbejdsmarked": 1,
                          "boligret": 1,
                          "digital_sikkerhed": 1,
                      },
                      min_posts_per_topic={"free_zone": 1}
                  )
                  # Guarantee Free Zone activity
                  from social_stream import ensure_free_zone_posts
                  ensured = ensure_free_zone_posts(min_count=2)
                  print(f"âœ… Free Zone ensured: {ensured}")
                  print("âœ… Created posts")
              except Exception as e:
                  print(f"âŒ Social HatasÄ±: {e}")

              # 3. Comments (randomized bursts)
              try:
                  bursts = random.randint(2, 4)
                  total_comments = 0
                  for _ in range(bursts):
                      min_c, max_c = _scale_range(20, 30)
                      comments = add_intelligent_comments(min_comments_per_post=min_c, max_comments_per_post=max_c)
                      total_comments += (comments or 0)
                      time.sleep(random.randint(8, 18))
                  print(f"âœ… Comments: {total_comments} added (bursts={bursts})")
              except Exception as e:
                  print(f"âŒ Yorum HatasÄ±: {e}")

              # 4. Voting
              try:
                  db = get_database()

                  posts_query = (
                      db.client
                      .table("posts")
                      .select("id")
                      .limit(15)
                      .execute()
                  )

                  agents_query = (
                      db.client
                      .table("agents")
                      .select("id")
                      .eq("is_active", True)
                      .limit(40)
                      .execute()
                  )

                  if posts_query.data and agents_query.data:
                      for post in posts_query.data:
                          for _ in range(random.randint(1, 3)):
                              voter = random.choice(agents_query.data)
                              vote_on_post(
                                  voter["id"],
                                  post["id"],
                                  use_ai_evaluation=False
                              )
                      print("âœ… Oylama tamamlandÄ±")
                  else:
                      print("âš ï¸ Oylama iÃ§in yeterli veri yok")

              except Exception as e:
                  print(f"âŒ Oylama HatasÄ±: {e}")

              # Pause to align roughly with per-minute cadence
              time.sleep(random.randint(35, 55))

          # 5. Election cycle (1-year compressed US model)
          try:
              from election_system import ensure_election_cycle
              result = ensure_election_cycle(term_days=365, primary_days=90, general_days=30)
              print(f"ðŸ—³ï¸ SeÃ§im dÃ¶ngÃ¼sÃ¼: {result}")
          except Exception as e:
              print(f"âŒ SeÃ§im DÃ¶ngÃ¼sÃ¼ HatasÄ±: {e}")
          
          # 6. Monthly report (run daily, creates once per month)
          try:
              from database import get_database
              db = get_database()
              report = db.generate_monthly_report()
              print(f"ðŸ“Š Monthly report: {report}")
          except Exception as e:
              print(f"âŒ Monthly report hatasÄ±: {e}")
          
          # 7. Daily quality control + AI revisions + apply updates + delete + personal reports
          try:
              from learning_system import daily_quality_control, process_revision_tasks, apply_revision_updates, delete_low_quality_posts, generate_personal_reports
              qc = daily_quality_control(limit_posts=50)
              rev = process_revision_tasks(max_tasks=10)
              applied = apply_revision_updates(max_apply=10)
              deleted = delete_low_quality_posts(limit_posts=50)
              pr = generate_personal_reports(max_agents=20)
              print(f"ðŸ§ª QC: {qc} | ðŸ› ï¸ Revisions: {rev} | âœ… Applied: {applied} | ðŸ—‘ï¸ Deleted: {deleted} | ðŸ“„ Personal: {pr}")
          except Exception as e:
              print(f"âŒ Learning system hatasÄ±: {e}")

          # 8. Orchestration: agent cells + consensus summaries
          try:
              from orchestration_engine import run_orchestration
              orch = run_orchestration(max_topics=5, cell_size=15)
              print(f"ðŸ§­ Orchestration: {orch}")
          except Exception as e:
              print(f"âŒ Orchestration hatasÄ±: {e}")

          print("ðŸ Operasyon baÅŸarÄ±yla tamamlandÄ±")
          PY
