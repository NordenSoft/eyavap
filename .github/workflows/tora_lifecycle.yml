name: Tora Legion Lifecycle

on:
  schedule:
    - cron: '0 */4 * * *' # Her 4 saatte bir (gÃ¼nde 6 kez)
  workflow_dispatch: # Manuel baÅŸlatma butonu

jobs:
  tora-activity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: pip install streamlit supabase openai google-generativeai feedparser python-dotenv
      - name: Execute Spawn & Intelligent Comments (Danish Content)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} 
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # ðŸ¦™ Llama HattÄ± (DeepInfra):
          DEEPINFRA_API_TOKEN: ${{ secrets.DEEPINFRA_API_TOKEN }}
        run: |
          python3 -c "
          import os
          os.environ['SUPABASE_URL'] = os.getenv('SUPABASE_URL', '')
          os.environ['SUPABASE_KEY'] = os.getenv('SUPABASE_KEY', '')
          
          # 1. Spawn new agents (10 per run = 60/day)
          from spawn_system import spawn_agents
          agents = spawn_agents(10)
          print(f'âœ… Spawned {len(agents)} agents')
          
          # 2. Create new posts from REAL Danish news (3 per run = 18/day)
          # + Run evolution controller (legacy agents evolve, gap-filling)
          from social_stream import simulate_social_activity
          stats = simulate_social_activity(3, 0, 0, use_news=True, run_evolution=True)  # ðŸ§¬ EVRIM AKTÄ°F
          print(f'âœ… Created: {stats.get(\"posts_created\", 0)} news-based posts')
          
          # 3. Intelligent comments (1-8 per post, stops when mature)
          from intelligent_comments import add_intelligent_comments
          comments = add_intelligent_comments(max_comments_per_post=8)
          print(f'âœ… Intelligent comments: {comments} added')
          
          # 4. Cast votes for consensus
          from social_stream import vote_on_post
          from database import get_database
          db = get_database()
          posts = db.client.table('posts').select('id').limit(20).execute().data
          active_agents = db.client.table('agents').select('id').eq('is_active', True).limit(50).execute().data
          import random
          votes_cast = 0
          for post in posts:
              for _ in range(random.randint(2, 5)):
                  if active_agents:
                      voter = random.choice(active_agents)
                      try:
                          vote_on_post(voter['id'], post['id'], use_ai_evaluation=False)
                          votes_cast += 1
                      except:
                          pass
          print(f'âœ… Votes cast: {votes_cast}')
          "
