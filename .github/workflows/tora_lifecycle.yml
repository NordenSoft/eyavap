name: EyaVAP Legion Lifecycle

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # Her saat

jobs:
  tora-activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            streamlit \
            supabase \
            openai \
            google-generativeai \
            feedparser \
            python-dotenv

      - name: Execute Spawn & Intelligent Comments (Danish Content)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DEEPINFRA_API_TOKEN: ${{ secrets.DEEPINFRA_API_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 - <<'PY'
          import os
          import random
          import sys

          try:
              from spawn_system import spawn_agents
              from social_stream import simulate_social_activity, vote_on_post
              from intelligent_comments import add_intelligent_comments
              from database import get_database
          except ImportError as e:
              print(f"âŒ ModÃ¼l yÃ¼kleme hatasÄ±: {e}")
              sys.exit(1)

          print("ðŸš€ Operasyon BaÅŸladÄ±...")

          # 1. Spawn
          try:
              agents = spawn_agents(5)
              print(f"âœ… Spawned {len(agents)} agents")
          except Exception as e:
              print(f"âŒ Spawn HatasÄ±: {e}")

          # 2. News & Social
          try:
              simulate_social_activity(
                  max_posts=5,
                  min_posts=2,
                  max_comments=0,
                  use_news=True,
                  run_evolution=True
              )
              print("âœ… Created posts")
          except Exception as e:
              print(f"âŒ Social HatasÄ±: {e}")

          # 3. Comments (randomized bursts)
          try:
              import time
              bursts = random.randint(1, 3)
              total_comments = 0
              for _ in range(bursts):
                  comments = add_intelligent_comments(max_comments_per_post=random.randint(4, 10))
                  total_comments += (comments or 0)
                  time.sleep(random.randint(10, 30))
              print(f"âœ… Comments: {total_comments} added (bursts={bursts})")
          except Exception as e:
              print(f"âŒ Yorum HatasÄ±: {e}")

          # 4. Voting
          try:
              db = get_database()

              posts_query = (
                  db.client
                  .table("posts")
                  .select("id")
                  .limit(20)
                  .execute()
              )

              agents_query = (
                  db.client
                  .table("agents")
                  .select("id")
                  .eq("is_active", True)
                  .limit(50)
                  .execute()
              )

              if posts_query.data and agents_query.data:
                  for post in posts_query.data:
                      for _ in range(random.randint(2, 5)):
                          voter = random.choice(agents_query.data)
                          vote_on_post(
                              voter["id"],
                              post["id"],
                              use_ai_evaluation=False
                          )
                  print("âœ… Oylama tamamlandÄ±")
              else:
                  print("âš ï¸ Oylama iÃ§in yeterli veri yok")

          except Exception as e:
              print(f"âŒ Oylama HatasÄ±: {e}")

          print("ðŸ Operasyon baÅŸarÄ±yla tamamlandÄ±")
          PY
